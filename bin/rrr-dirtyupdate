#!/usr/bin/perl -- -*- mode: cperl -*-

=head1 NAME

rrr-dirtyupdate - add a file with an old timestamp to the dataset

=head1 SYNOPSIS

  rrr-dirtyupdate [options] file epoch

=head1 OPTIONS

=over 8

=cut

my @opt = <<'=back' =~ /B<--(\S+)>/g;

=item B<--dry-run!>

(TBD) Do not really run the command, ...

=item B<--help|h>

Prints a brief message and exists.

=item B<--verbose|v+>

More feedback.

=back

=head1 DESCRIPTION

When you later discover missing files...

=head1 BUGS

This is slow: it calls aggregate twice with force which took 2 x 10-15 seconds on PAUSE.

=cut


use strict;
use warnings;

use File::Rsync::Mirror::Recent;
use Getopt::Long;
use Pod::Usage qw(pod2usage);

our %Opt;
GetOptions(\%Opt,
           @opt,
          ) or pod2usage(1);

if ($Opt{help}) {
    pod2usage(0);
}

unless (@ARGV) {
    pod2usage(1);
}

# my($file,$epoch) = @ARGV; # XXX

if ($Opt{'dry-run'}) {
    die "FIXME: not yet implemented";
}

my $rf = File::Rsync::Mirror::Recentfile->new_from_file
    (
     "/home/ftp/pub/PAUSE/authors/RECENT-1h.yaml",
    );
unless ($rf) {
    die "ALERT: Could not create an rf: $@";
}
my $sleep = 2;
warn "prove of concept for one file only. Last chance to hit ^C now to interrupt. sleeping $sleep";
sleep $sleep;

my @files = qw(
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/angelgrep.gz
/home/ftp/pub/PAUSE/authors/id/G/GA/GAND/HTML-0.6.readme
/home/ftp/pub/PAUSE/authors/id/M/MI/MICB/TclTk-b1.readme
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/rprint/t1.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/rprint/testD.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/rprint/testpref.gz
/home/ftp/pub/PAUSE/authors/id/M/MI/MICB/Tcl-b1.readme
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/findbig.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/manpath.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/manpath-verbose.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/sortbylen.gz
/home/ftp/pub/PAUSE/authors/id/I/IL/ILYAZ/modules/FreezeThaw-0.3.readme
/home/ftp/pub/PAUSE/authors/id/I/IL/ILYAZ/modules/FreezeThaw-0.41.readme
/home/ftp/pub/PAUSE/authors/id/I/IL/ILYAZ/modules/FreezeThaw-0.43.readme
/home/ftp/pub/PAUSE/authors/id/I/IL/ILYAZ/modules/FreezeThaw-0.44.readme
/home/ftp/pub/PAUSE/authors/id/I/IL/ILYAZ/modules/FreezeThaw-0.45.readme
/home/ftp/pub/PAUSE/authors/id/I/IL/ILYAZ/modules/FreezeThaw-0.4.readme
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/cgi/picknewsgroups.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/net/getng.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/net/TCP/Client.pm.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/tk/netcomplain.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/tk/servomatic.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/cgi/picknewsgroups.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/net/fing.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/net/pquote.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/nice/Nice-old.pm.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/nice/Nice.pm.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/nice/testnice.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/net/daytime.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/bad.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/rprint/Bug-Report.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/rprint/getdots.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/rprint/getdots-strict.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/rprint/pref.pm.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/bad.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/binstuff/cpfiles.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/binstuff/cut.pl.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/binstuff/lastlog-better.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/binstuff/lastlog.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/binstuff/SYS/lastlog.pm.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/msort/sortm-addrdate.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/msort/sortm-bysub.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/msort/sortm-datesub.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/tee/tctee-v4.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/tee/tctee-v5.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/lst/lst.fancy.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/lst/lst.fancy.SYS.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/lst/lst.simple.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/matchem/match_any.pl.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/timeouts/testmod.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/timeouts/TimeOut.pm.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/timeouts/timeout-v4.pl.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/timeouts/timeout-v5.pl.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ndf.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/net/statmon.gz
/home/ftp/pub/PAUSE/authors/id/J/JK/JKAST/StatisticsDescriptive-1.1.readme
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/pt.shar.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/sortbylast.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/cgi/pickcards.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/cgi/pickcards.gz
/home/ftp/pub/PAUSE/authors/id/W/WP/WPS/Curses-a8.readme
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/cgi/Card-Form.html
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/cgi/Card-Form.html
/home/ftp/pub/PAUSE/authors/id/K/KJ/KJALB/Ioctl-0.5.readme
/home/ftp/pub/PAUSE/authors/id/K/KJ/KJALB/Ioctl-0_7.readme
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/cgi/Card-Index.html
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/cgi/Card-Index.html
/home/ftp/pub/PAUSE/authors/id/A/AM/AMOSS/SGI-GL-0.2.readme
/home/ftp/pub/PAUSE/authors/id/A/AM/AMOSS/SGI-FM-0.1.readme
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/ADVLABS/cgi/gencards.gz
/home/ftp/pub/PAUSE/authors/id/T/TO/TOMC/scripts/cgi/gencards.gz
);

my $files = @files;
warn "($files files)starting at ".localtime;
for my $file (@files) {
    my @stat = stat $file or die "Couldn't stat '$file': $!";
    my $mtime = $stat[9];
    $rf->update($file,"new",$mtime);
}
warn "starting first aggregate at ".localtime;
$rf->aggregate(force => 1);
warn "starting second aggregate at ".localtime;
$rf->aggregate(force => 1);
warn "finished at ".localtime;

__END__


# Local Variables:
# mode: cperl
# coding: utf-8
# cperl-indent-level: 4
# End:
